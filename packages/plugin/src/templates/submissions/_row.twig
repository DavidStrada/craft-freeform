{% macro render(row, submission, fieldRenderer) %}
    {% import "_includes/forms" as forms %}

    <div class="fields-row">
        {%- for field in row.getFields(["password", "hidden", "invisible"], "excludes") -%}
            {% do field.attributes.container.set("class", [
                'fields-column',
                field.required ?: 'field-required',
            ]) %}

            <div{{ field.attributes.container }}>
                {% set fieldHandle = field.handle %}

                {% if field.canStoreValues %}
                    {% set value = submission[fieldHandle].value %}

                    {% set options = {
                        label: field.label,
                        name: fieldHandle,
                        id: fieldHandle,
                        value: value,
                        required: field.required,
                        errors: submission.errors(fieldHandle),
                        first: loop.index0 == 0,
                    } %}

                    {% if field.type in ["confirm", "text", "email", "datetime", "number", "phone", "regex", "website"] %}
                        {{ forms.textField(options|merge({
                            placeholder: field.placeholder,
                        })) }}
                    {% elseif field.type == "checkbox" %}
                        {% set checkboxInput %}
                            {{ forms.checkboxField({
                                label: field.label,
                                name: fieldHandle,
                                id: fieldHandle,
                                checked: value ? true : false,
                                value: field.defaultValue,
                            }) }}
                        {% endset %}

                        {{ forms.field({
                            label: null,
                            class: "checkbox-field",
                            errors: submission.errors(fieldHandle),
                            required: field.required,
                        }, checkboxInput) }}

                    {% elseif field.type == "textarea" %}
                        {{ forms.textareaField(options|merge({
                            placeholder: field.placeholder,
                            rows: field.rows,
                            value: value
                        })) }}
                    {% elseif field.type == "dropdown" %}
                        {{ forms.selectField(options|merge({
                            options: field.options.toTwigArray,
                        })) }}
                    {% elseif field.type == "multiple-select" %}
                        {{ forms.multiselectField(options|merge({
                            options: field.options.toTwigArray,
                            values: value,
                        })) }}
                    {% elseif field.type == "checkboxes" %}
                        {{ forms.checkboxSelectField(options|merge({
                            showAllOption: false,
                            options: field.options.toTwigArray,
                            values: value,
                        })) }}
                    {% elseif field.type == "radios" %}
                        {{ forms.radioGroupField(options|merge({
                            options: field.options.toTwigArray,
                        })) }}
                    {% elseif field.type == "rating" %}

                        <div class="field">
                            <div class="heading">
                                <label>{{ field.label }}</label>
                            </div>
                            <div>
                                {% set field = field.setValue(value) %}
                                {{ field.renderInput }}
                            </div>
                        </div>

                    {% elseif field.type == "opinion-scale" %}
                        {% set field = field.setValue(value) %}

                        <div class="field">
                            <div class="heading">
                                {{ field.label }}
                            </div>
                            <div class="opinion-scale">
                                <ul class="opinion-scale-scales">
                                    {% for index, scale in field.scales %}
                                        <li>
                                            <input type="radio"
                                                   id="{{ field.handle ~ '-' ~ index }}"
                                                   name="{{ field.handle }}"
                                                   autocomplete="off"
                                                   value="{{ scale.value }}"
                                                    {{ field.value == scale.value ? "checked" }}
                                            />
                                            <label for="{{ field.handle ~ '-' ~ index }}">
                                                {{ scale.label }}
                                            </label>
                                        </li>
                                    {% endfor %}
                                </ul>
                                <ul class="opinion-scale-legends">
                                    {% for legend in field.legends %}
                                        <li>{{ legend|t("app") }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>

                    {% elseif field.type in ["file", "file-dnd"] %}
                        <div class="field">
                            <div class="heading">
                                <label>{{ field.label }}</label>
                            </div>
                            <div class="file-preview">
                                {% set assets = submission.getAssets(field.handle) %}

                                {% if assets %}
                                    {% for asset in assets|filter(asset => asset is not null) %}
                                        {% set thumbSizes = [30, 60, 100, 200] %}
                                        {% set srcset = "" %}
                                        {%- for size in thumbSizes -%}{% set srcset = srcset ~ ", " ~ asset.thumbUrl(size) ~ " " ~ size ~ "w" %}{%- endfor -%}
                                        {% set srcset = srcset|trim(", ") %}

                                        <div class="element small removable hasthumb" style="padding-right: 20px;">
                                            <input type="hidden" name="{{ field.handle }}[]"
                                                   value="{{ asset.id }}">
                                            <a href="javascript:;" onclick="removeAsset(this);" class="icon delete"></a>
                                            <div class="elementthumb">
                                                <img sizes="30px" srcset="{{ srcset }}" alt="">
                                            </div>
                                            <label>
                                                <a href="javascript:;" data-asset-id="{{ asset.id }}">
                                                    {{ asset.title }}
                                                </a>
                                            </label>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    {{ "No files uploaded"|t('freeform') }}
                                {% endif %}
                            </div>
                            <div class="field">
                                <input type="file" name="{{ field.handle }}[]" multiple />
                            </div>
                        </div>

                    {% elseif field.type == "signature" %}

                        <div class="field">
                            <div class="heading">
                                <label>{{ field.label }}</label>
                            </div>
                            <div class="signature-wrapper">
                                <input type="hidden" name="{{ field.handle }}" value="{{ submission[field.handle] }}" />
                                <canvas data-image="{{ submission[field.handle] }}"
                                        width="{{ field.width }}"
                                        height="{{ field.height }}"
                                        style="border: 1px solid {{ field.borderColor }}; padding: 1px;"
                                >Your browser does not support canvas</canvas>

                                <div class="btngroup small download-signature-links">
                                    <a href="javascript:;"
                                       data-type="png"
                                       class="btn small">PNG</a>
                                    <a href="javascript:;"
                                       data-type="jpg"
                                       class="btn small">JPG</a>
                                </div>
                            </div>
                        </div>

                    {% elseif field.type == "table" %}

                        <div class="field" data-freeform-table>
                            <div class="heading">
                                <label>{{ field.label }}</label>
                            </div>
                            <table class="shadow-box editable fullwidth">
                                <thead>
                                <tr>
                                    {% for column in field.tableLayout %}
                                        <th>
                                            {{ column.label|default('') }}
                                        </th>
                                    {% endfor %}
                                    <th></th>
                                </tr>
                                </thead>
                                <tbody>
                                {% if submission[field.handle].value is empty %}
                                    <tr>
                                        {% for index, column in field.tableLayout %}
                                            {% set colName = field.handle ~ "[0][" ~ index ~ "]" %}
                                            {% set colType = column.type|default("text") %}
                                            {% set colClass = "" %}
                                            {% if colType == "text" %}
                                                {% set colClass = "textual" %}
                                            {% elseif colType == "select" %}
                                                {% set colClass = "thin" %}
                                            {% endif %}
                                            <td class="{{ colClass }}">
                                                {% switch colType %}
                                                {% case "select" %}
                                                    <div class="select small">
                                                        <select name="{{ colName }}"
                                                                data-default-value="{{ column.value|default("") }}"
                                                        >
                                                            {% for option in column.value|default("")|split(";") %}
                                                                <option value="{{ option }}">
                                                                    {{ option }}
                                                                </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                {% case "checkbox" %}
                                                    <input type="checkbox"
                                                           data-default-value="{{ column.value|default("Yes") }}"
                                                           name="{{ colName }}"
                                                           value="{{ column.value|default("Yes") }}"
                                                    />
                                                {% default %}
                                                    <textarea name="{{ colName }}"
                                                              data-default-value="{{ column.value|default("") }}"
                                                              rows="1"
                                                    >
                                                                        {{- column.value|default("") -}}
                                                                    </textarea>
                                                {% endswitch %}
                                            </td>
                                        {% endfor %}
                                        <td class="thin action">
                                            <a class="delete icon"
                                               data-freeform-table-remove-row
                                               title="Delete"></a>
                                        </td>
                                    </tr>
                                {% else %}
                                    {% for rowIndex, row in submission[field.handle].value %}
                                        <tr>
                                            {% for index, column in field.tableLayout %}
                                                {% set colName = field.handle ~ "[" ~ rowIndex ~ "][" ~ index ~ "]" %}
                                                {% set colValue = row[index]|default("") %}
                                                {% set colType = column.type|default("text") %}
                                                {% set colClass = "" %}
                                                {% if colType == "text" %}
                                                    {% set colClass = "textual" %}
                                                {% elseif colType == "select" %}
                                                    {% set colClass = "thin" %}
                                                {% endif %}
                                                <td class="{{ colClass }}">
                                                    {% switch colType %}
                                                    {% case "select" %}
                                                        <div class="select small">
                                                            <select name="{{ colName }}"
                                                                    data-default-value="{{ column.value|default("") }}"
                                                            >
                                                                {% for option in column.value|default("")|split(";") %}
                                                                    <option value="{{ option }}"{{ option == colValue ? " selected" }}>
                                                                        {{ option }}
                                                                    </option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                    {% case "checkbox" %}
                                                        <input type="checkbox"
                                                               name="{{ colName }}"
                                                               data-default-value="{{ column.value|default("Yes") }}"
                                                               value="{{ column.value|default("Yes") }}"
                                                                {{ colValue ? "checked" }}
                                                        />
                                                    {% default %}
                                                        <textarea name="{{ colName }}"
                                                                  data-default-value="{{ column.value|default("") }}"
                                                                  rows="1"
                                                        >
                                                                            {{- colValue -}}
                                                                        </textarea>
                                                    {% endswitch %}
                                                </td>
                                            {% endfor %}
                                            <td class="thin action">
                                                <a class="delete icon"
                                                   data-freeform-table-remove-row
                                                   title="Delete"></a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% endif %}
                                </tbody>
                            </table>
                            <div class="btn add icon"
                                 data-freeform-table-add-row
                                 tabindex="0">
                                {{ "Add a row"|t }}
                            </div>
                        </div>

                    {% endif %}

                {% else %}
                    {% if field.type == "html" %}

                        {% if craft.freeform.settings.renderFormHtmlInCpViews %}
                            {{ field.render }}
                        {% else %}
                            {{ "Live HTML rendering currently disabled."|t("freeform") }}
                        {% endif %}

                    {% elseif field.type == "group" %}

                        <fieldset class="group">
                            <legend>{{ field.label }}</legend>

                            {% for groupRow in field.layout %}

                                {{ _self.render(groupRow, submission) }}

                            {% endfor %}

                        </fieldset>

                    {% elseif field.type != "recaptcha" %}

                        {{ field.render }}

                    {% endif %}

                {% endif %}

            </div>
        {% endfor %}
    </div>
{% endmacro %}
